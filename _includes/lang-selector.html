<link rel="stylesheet" href="{{ '/assets/css/lang-selector.css' | relative_url }}">

<div class="lang-dropdown">
  <select id="langSelect" class="lang-select" aria-label="Select Language">
    {%- for lang in site.languages -%}
      <option
        data-lang="{{ lang }}"
        value="{% if lang == site.default_lang %}{{ page.url }}{% else %}/{{ lang }}{{ page.url }}{% endif %}"
        {% if lang == site.active_lang %}
          selected="selected"
        {% endif %}
      >
        {% case lang %}
          {% when 'en' -%}
            ðŸ‡ºðŸ‡¸ English
          {% when 'fr' -%}
            ðŸ‡«ðŸ‡· French
          {% when 'de' -%}
            ðŸ‡©ðŸ‡ª German
          {% else -%}
            {{- lang }}
        {% endcase %}
      </option>
    {%- endfor -%}
  </select>
</div>

<script>
  (function () {
    const STORAGE_KEY = 'preferred_lang';
    const selectEl = document.getElementById('langSelect');
    if (!selectEl) return;

    const supported = Array.from(selectEl.options)
      .map((o) => o.dataset.lang)
      .filter(Boolean);
    const activeLang = '{{ site.active_lang }}';

    const normalizeLang = (tag) => (tag ? String(tag).toLowerCase().split('-')[0] : null);

    const getBrowserPreferredLang = () => {
      const langs = navigator.languages && navigator.languages.length ? navigator.languages : [navigator.language];
      for (const tag of langs) {
        const base = normalizeLang(tag);
        if (base && supported.includes(base)) return base;
      }
      return null;
    };

    const urlForLang = (lang) => {
      const opt = Array.from(selectEl.options).find((o) => o.dataset.lang === lang);
      return opt ? opt.value : null;
    };

    const samePath = (targetUrl) => {
      try {
        const target = new URL(targetUrl, window.location.origin);
        return target.pathname === window.location.pathname;
      } catch (e) {
        return false;
      }
    };

    const stored = normalizeLang(localStorage.getItem(STORAGE_KEY));

    if (stored && supported.includes(stored) && stored !== activeLang) {
      const target = urlForLang(stored);
      if (target && !samePath(target)) {
        window.location.replace(target);
        return;
      }
    }

    if (!stored) {
      const preferred = getBrowserPreferredLang();
      if (preferred && preferred !== activeLang) {
        const target = urlForLang(preferred);
        if (target && !samePath(target)) {
          localStorage.setItem(STORAGE_KEY, preferred);
          window.location.replace(target);
          return;
        }
      }
    }

    selectEl.addEventListener('change', () => {
      const chosenLang = selectEl.options[selectEl.selectedIndex].dataset.lang;
      if (chosenLang) localStorage.setItem(STORAGE_KEY, normalizeLang(chosenLang));
      window.location.href = selectEl.value;
    });
  })();
</script>
